"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=void 0;const getStream=function({link:link,providerContext:providerContext}){const{axios:axios,cheerio:cheerio,commonHeaders:commonHeaders}=providerContext,epMatch=link.match(/[?&]ep=(\d+)/),episodeId=epMatch?epMatch[1]:null;if(!episodeId)return Promise.resolve([]);const serversUrl=`https://kaido.to/ajax/episode/servers?episodeId=${episodeId}`;return axios.get(serversUrl,{headers:commonHeaders}).then(res=>{const data=res.data;if(!data||!data.html)return[];const $=cheerio.load(data.html),serverTasks=[];return $(".server-item").each((_,el)=>{const item=$(el),sourceId=item.attr("data-id"),type=item.attr("data-type");sourceId&&serverTasks.push(resolveSource(sourceId,type||"sub",axios,commonHeaders))}),Promise.all(serverTasks).then(all=>all.flat().filter(Boolean))}).catch(()=>[])};function resolveSource(sourceId,type,axios,headers){const sourceUrl=`https://kaido.to/ajax/episode/sources?id=${sourceId}`;return axios.get(sourceUrl,{headers:headers}).then(res=>{const data=res.data;if(!data||!data.link)return[];const match=data.link.match(/\/e-\d+\/([^?]+)/),videoId=match?match[1]:null;if(!videoId)return[];const rapidApi=`https://rapid-cloud.co/embed-2/v2/e-1/getSources?id=${videoId}`;return axios.get(rapidApi,{headers:headers}).then(apiRes=>{const srcData=apiRes.data;if(!srcData)return[];const subtitles=Array.isArray(srcData.tracks)?srcData.tracks.filter(t=>"captions"===t.kind).map(t=>({title:t.label||"English",language:(t.label||"en").toLowerCase(),type:"text/vtt",uri:t.file})):[],streams=[];return Array.isArray(srcData.sources)&&srcData.sources.forEach(s=>{"hls"===s.type&&s.file&&streams.push({server:"dub"===type?"kaido-dub":"kaido-sub",link:s.file,type:"m3u8",subtitles:subtitles})}),streams})}).catch(()=>[])}exports.getStream=getStream;