"use strict";function decodeBase64(input){try{if("function"==typeof atob)return decodeURIComponent(Array.prototype.map.call(atob(input),c=>"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)).join(""))}catch(_a){}try{return Buffer.from(input,"base64").toString("utf-8")}catch(_b){return""}}function extractM3U8(text){const m=text.match(/https?:\/\/[^\s"'<>]+\.m3u8[^\s"'<>]*/);return m?m[0]:null}function extractMP4(text){const m=text.match(/https?:\/\/[^\s"'<>]+\.mp4[^\s"'<>]*/);return m?m[0]:null}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=void 0;const getStream=function({link:link,providerContext:providerContext}){const{axios:axios,cheerio:cheerio,commonHeaders:commonHeaders}=providerContext;return axios.get(link,{headers:commonHeaders}).then(res=>{const iframeSrc=cheerio.load(res.data||"")("div.embed iframe").attr("src");if(!iframeSrc)return[];const iframeUrl=iframeSrc.startsWith("http")?iframeSrc:new URL(iframeSrc,link).href;return axios.get(iframeUrl,{headers:{...commonHeaders,referer:link}}).then(iframeRes=>{const $$=cheerio.load(iframeRes.data||""),tasks=[];return $$("li[onclick]").each((_,el)=>{var _a;const base64=null===(_a=($$(el).attr("onclick")||"").split("showVideo('")[1])||void 0===_a?void 0:_a.split("',")[0];if(!base64)return;const decodedUrl=decodeBase64(base64);if(!decodedUrl)return;const serverName=$$(el).text().trim()||"Server",task=axios.get(decodedUrl,{headers:{...commonHeaders,referer:iframeUrl},maxRedirects:5,timeout:1e4}).then(playerRes=>{var _a,_b;const body="string"==typeof playerRes.data?playerRes.data:JSON.stringify(playerRes.data),m3u8=extractM3U8(body);if(m3u8)return{server:serverName,link:m3u8,type:"m3u8"};const mp4=extractMP4(body);if(mp4)return{server:serverName,link:mp4,type:"mp4"};const finalUrl=(null===(_b=null===(_a=playerRes.request)||void 0===_a?void 0:_a.res)||void 0===_b?void 0:_b.responseUrl)||"";return finalUrl.endsWith(".mp4")?{server:serverName,link:finalUrl,type:"mp4"}:null}).catch(()=>null);tasks.push(task)}),Promise.all(tasks).then(results=>results.filter(Boolean))})}).catch(err=>[])};exports.getStream=getStream;