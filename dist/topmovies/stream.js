"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=getStream;const headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","Cache-Control":"no-store","Accept-Language":"en-US,en;q=0.9",DNT:"1","sec-ch-ua":'"Not_A Brand";v="8", "Chromium";v="120", "Microsoft Edge";v="120"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"',"Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate",Cookie:"popads_user_id=6ba8fe60a481387a3249f05aa058822d","Sec-Fetch-Site":"none","Sec-Fetch-User":"?1","Upgrade-Insecure-Requests":"1","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0"};function modExtractor(url,providerContext){const{axios:axios,cheerio:cheerio}=providerContext;try{const wpHttp=url.split("sid=")[1],bodyFormData0=new FormData;return bodyFormData0.append("_wp_http",wpHttp),fetch(url.split("?")[0],{method:"POST",body:bodyFormData0}).then(res=>res.text()).then(html=>{const $=cheerio.load(html),wpHttp2=$("input[name='_wp_http2']").val();if("string"!=typeof wpHttp2)throw new Error("Could not find _wp_http2 value or value is invalid.");const bodyFormData=new FormData;bodyFormData.append("_wp_http2",wpHttp2);const formUrl=$("form").attr("action")||url.split("?")[0];return fetch(formUrl,{method:"POST",body:bodyFormData}).then(res2=>res2.text()).then(html2=>{const linkMatch=html2.match(/setAttribute\("href",\s*"(.*?)"/);if(!linkMatch)throw new Error("Could not find download link in form response.");const link=linkMatch[1],cookie=link.split("=")[1];return axios.get(link,{headers:{Referer:formUrl,Cookie:`${cookie}=${wpHttp2}`}})})}).catch(err=>Promise.reject(err))}catch(err){return Promise.reject(err)}}const isDriveLink=ddl=>ddl.includes("drive")?fetch(ddl).then(driveLeach=>driveLeach.text()).then(driveLeachData=>{const pathMatch=driveLeachData.match(/window\.location\.replace\("([^"]+)"\)/),path=null==pathMatch?void 0:pathMatch[1],mainUrl=ddl.split("/")[2];return path?`https://${mainUrl}${path}`:ddl}).catch(err=>ddl):Promise.resolve(ddl);function modGetEpisodeLinks({url:url,providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext;try{return url.includes("url=")&&(url=atob(url.split("url=")[1])),axios.get(url).then(res=>{var _a;const html=res.data;let $=cheerio.load(html);if(url.includes("url=")){const newUrl=null===(_a=$("meta[http-equiv='refresh']").attr("content"))||void 0===_a?void 0:_a.split("url=")[1];if(newUrl)return axios.get(newUrl).then(res2=>{const html2=res2.data;return $=cheerio.load(html2),$}).catch(()=>$)}return $}).then($=>{const episodeLinks=[];return $("h3,h4").map((i,element)=>{const seriesTitle=$(element).text(),episodesLink=$(element).find("a").attr("href");episodesLink&&"#"!==episodesLink&&episodeLinks.push({title:seriesTitle.trim()||"No title found",link:episodesLink||""})}),$("a.maxbutton").map((i,element)=>{const seriesTitle=$(element).children("span").text(),episodesLink=$(element).attr("href");episodesLink&&"#"!==episodesLink&&episodeLinks.push({title:seriesTitle.trim()||"No title found",link:episodesLink||""})}),episodeLinks})}catch(err){return Promise.resolve([])}}function getStream({link:url,type:type,providerContext:providerContext}){const{axios:axios,cheerio:cheerio}=providerContext;let finalDriveLink,resumeBot,currentUrl=url;return Promise.resolve().then(()=>"movie"===type?modGetEpisodeLinks({url:currentUrl,providerContext:providerContext}).then(servers=>{var _a;currentUrl=(null===(_a=servers[0])||void 0===_a?void 0:_a.link)||currentUrl}):Promise.resolve()).then(()=>modExtractor(currentUrl,providerContext)).then(downloadLink=>{var _a,_b;const ddl=(null===(_b=null===(_a=null==downloadLink?void 0:downloadLink.data)||void 0===_a?void 0:_a.match(/content="0;url=(.*?)"/))||void 0===_b?void 0:_b[1])||currentUrl;return isDriveLink(ddl)}).then(driveLink=>(finalDriveLink=driveLink,axios.get(finalDriveLink,{headers:headers}).then(driveRes=>{const driveHtml=driveRes.data,$drive=cheerio.load(driveHtml),servers=[],tryFetch=promise=>promise.catch(err=>null),getCfWorkerLinks=(typeNum,driveLink,headers,cheerio,servers)=>{const cfWorkersLink=driveLink.replace("/file","/wfile")+`?type=${typeNum}`;return tryFetch(axios.get(cfWorkersLink,{headers:headers})).then(cfWorkersRes=>{if(!cfWorkersRes)return;const cfWorkersHtml=cfWorkersRes.data;cheerio.load(cfWorkersHtml)(".btn-success").each((i,el)=>{var _a;const link=null===(_a=el.attribs)||void 0===_a?void 0:_a.href;link&&servers.push({server:`Cf Worker ${typeNum}.${i}`,link:link,type:"mkv"})})})},extractionPromises=[];return resumeBot=$drive(".btn.btn-light").attr("href")||"",extractionPromises.push(tryFetch(Promise.resolve().then(()=>{if(!resumeBot)throw new Error("ResumeBot link not found.");return axios.get(resumeBot,{headers:headers})}).then(resumeBotRes=>{const tokenMatch=resumeBotRes.data.match(/formData\.append\('token', '([a-f0-9]+)'\)/),pathMatch=resumeBotRes.data.match(/fetch\('\/download\?id=([a-zA-Z0-9\/+]+)'/);if(!tokenMatch||!pathMatch)throw new Error("ResumeBot tokens/path not found.");const resumeBotToken=tokenMatch[1],resumeBotPath=pathMatch[1],resumeBotBody=new FormData;resumeBotBody.append("token",resumeBotToken);const resumeBotBaseUrl=resumeBot.split("/download")[0];return fetch(resumeBotBaseUrl+"/download?id="+resumeBotPath,{method:"POST",body:resumeBotBody,headers:{Referer:resumeBot,Cookie:"PHPSESSID=7e9658ce7c805dab5bbcea9046f7f308"}})}).then(resumeBotDownload=>resumeBotDownload.json()).then(resumeBotDownloadData=>{resumeBotDownloadData.url&&servers.push({server:"ResumeBot",link:resumeBotDownloadData.url,type:"mkv"})}))),extractionPromises.push(Promise.resolve().then(()=>{$drive(".btn-success").each((i,el)=>{var _a;const link=null===(_a=el.attribs)||void 0===_a?void 0:_a.href;link&&servers.push({server:"Resume Worker "+(i+1),link:link,type:"mkv"})})})),extractionPromises.push(getCfWorkerLinks(1,finalDriveLink,headers,cheerio,servers)),extractionPromises.push(getCfWorkerLinks(2,finalDriveLink,headers,cheerio,servers)),extractionPromises.push(tryFetch(Promise.resolve().then(()=>{const seed=$drive(".btn-danger").attr("href")||"";if(!seed)throw new Error("Gdrive-Instant seed link not found.");return fetch(seed,{method:"HEAD",headers:headers,redirect:"manual"})}).then(newLinkRes=>{const seed=$drive(".btn-danger").attr("href")||"";let newLink=seed;const location=newLinkRes.headers.get("location");newLinkRes.status>=300&&newLinkRes.status<400&&location?newLink=location:newLinkRes.url&&newLinkRes.url!==seed?newLink=newLinkRes.url:location&&(newLink=location),servers.push({server:"Gdrive-Instant-2",link:(null==newLink?void 0:newLink.split("?url=")[1])||newLink,type:"mkv"})}))),Promise.all(extractionPromises).then(()=>servers)}))).catch(err=>[])}