"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=getStream;const headers={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",Referer:"https://fibwatch.biz/"};async function resolveServerLink(url,axios,cheerio,signal){if(/\.(mkv|mp4|m3u8)$/i.test(url)||/hubcloud/i.test(url))return url;try{const res=await axios.get(url,{headers:headers,signal:signal}),$=cheerio.load(res.data||""),onclick=$("a.hidden-button.buttonDownloadnew").attr("onclick");if(onclick){const match=onclick.match(/url=(.*?)',/);if(null==match?void 0:match[1])return match[1].trim()}const direct=$("video source").attr("src")||$("video").attr("src");if(direct)return direct}catch(_a){return null}return null}async function getStream({link:link,signal:signal,providerContext:providerContext}){const{axios:axios,cheerio:cheerio,extractors:extractors,getBaseUrl:getBaseUrl}=providerContext,{hubcloudExtracter:hubcloudExtracter}=extractors;try{const baseUrl=await getBaseUrl("fibtoon"),streams=[],res=await axios.get(link,{headers:headers,signal:signal}),$=cheerio.load(res.data||""),serverLinks=[],videoId=$("input#video-id").attr("value");if(Boolean(videoId)&&videoId){try{const ajaxUrl=`${baseUrl}/ajax/resolution_switcher.php?video_id=${videoId}`,ajaxData=(await axios.get(ajaxUrl,{headers:{...headers,"X-Requested-With":"XMLHttpRequest"},signal:signal})).data||{},rawLinks=[...ajaxData.current||[],...ajaxData.popup||[]];for(const item of rawLinks){if(!(null==item?void 0:item.url))continue;const fullUrl=item.url.startsWith("http")?item.url:`${baseUrl}${item.url}`;serverLinks.push({quality:item.res||"HD",url:fullUrl})}}catch(_a){}if(0===serverLinks.length){const onclick=$("a.hidden-button.buttonDownloadnew").attr("onclick");if(onclick){const match=onclick.match(/url=(.*?)',/);(null==match?void 0:match[1])&&serverLinks.push({quality:"Direct",url:match[1].trim()})}}}else serverLinks.push({quality:"Default",url:link});for(const server of serverLinks){const finalUrl=await resolveServerLink(server.url,axios,cheerio,signal);if(finalUrl)if(/hubcloud/i.test(finalUrl))try{const hubStreams=await hubcloudExtracter(finalUrl,signal);streams.push(...hubStreams)}catch(_b){}else streams.push({server:`FibWatch ${server.quality}`,link:finalUrl,type:finalUrl.includes(".m3u8")?"hls":"mp4"})}return streams}catch(error){return null==error||error.name,[]}}