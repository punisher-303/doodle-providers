"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=void 0;const headers={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",Referer:"https://fibwatchdrama.xyz/"},resolveServerLink=function(url,axios,cheerio,signal){return/\.(mkv|mp4|m3u8)(\?.*)?$/i.test(url)||/hubcloud/i.test(url)?Promise.resolve(url):axios.get(url,{headers:headers,signal:signal}).then(res=>{const $=cheerio.load(res.data||""),onclick=$("a.hidden-button.buttonDownloadnew").attr("onclick");if(onclick){const match=onclick.match(/url=(.*?)',/);if(null==match?void 0:match[1])return match[1].trim()}const direct=$("video source").attr("src")||$("video").attr("src");return direct||null}).catch(()=>null)},getStream=function({link:link,providerContext:providerContext,signal:signal}){const{axios:axios,cheerio:cheerio,extractors:extractors,getBaseUrl:getBaseUrl}=providerContext,{hubcloudExtracter:hubcloudExtracter}=extractors;return/\.(mkv|mp4|m3u8)(\?.*)?$/i.test(link)?Promise.resolve([{server:"FibDrama Direct",link:link,type:link.includes(".m3u8")?"hls":"mp4"}]):getBaseUrl("fibdrama").then(baseUrl=>axios.get(link,{headers:headers,signal:signal}).then(res=>{const $=cheerio.load(res.data||""),serverLinks=[],streams=[],videoId=$("input#video-id").attr("value");let linkPromise=Promise.resolve();if(videoId){const ajaxUrl=`${baseUrl}/ajax/resolution_switcher.php?video_id=${videoId}`;linkPromise=axios.get(ajaxUrl,{headers:{...headers,"X-Requested-With":"XMLHttpRequest"},signal:signal}).then(ajaxRes=>{const ajaxData=ajaxRes.data||{};[...ajaxData.current||[],...ajaxData.popup||[]].forEach(item=>{if(null==item?void 0:item.url){const fullUrl=item.url.startsWith("http")?item.url:`${baseUrl}${item.url.startsWith("/")?"":"/"}${item.url}`;serverLinks.push({quality:item.res||"HD",url:fullUrl})}})}).catch(()=>{}).then(()=>{if(0===serverLinks.length){const onclick=$("a.hidden-button.buttonDownloadnew").attr("onclick");if(onclick){const match=onclick.match(/url=(.*?)',/);(null==match?void 0:match[1])&&serverLinks.push({quality:"Direct",url:match[1].trim()})}}})}else serverLinks.push({quality:"Default",url:link});return linkPromise.then(()=>{const streamPromises=serverLinks.map(server=>resolveServerLink(server.url,axios,cheerio,signal).then(finalUrl=>{if(finalUrl)return/hubcloud/i.test(finalUrl)?hubcloudExtracter?hubcloudExtracter(finalUrl,signal).then(hubStreams=>{Array.isArray(hubStreams)&&streams.push(...hubStreams)}).catch(()=>{}):void 0:void streams.push({server:`FibDrama ${server.quality}`,link:finalUrl,type:finalUrl.includes(".m3u8")?"hls":"mp4"})}));return Promise.all(streamPromises).then(()=>streams)})}).catch(error=>(null==error||error.name,[])))};exports.getStream=getStream;