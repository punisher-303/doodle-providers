"use strict";function decodeBase64(input){try{if("function"==typeof atob)return decodeURIComponent(Array.prototype.map.call(atob(input),c=>"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)).join(""))}catch(_a){}try{return Buffer.from(input,"base64").toString("utf-8")}catch(_b){return""}}function extractM3U8(text){const m=text.match(/https?:\/\/[^\s"'<>]+\.m3u8[^\s"'<>]*/);return m?m[0]:null}function extractMP4(text){const m=text.match(/https?:\/\/[^\s"'<>]+\.mp4[^\s"'<>]*/);return m?m[0]:null}function buildM3U8Stream(server,link){const isLulu=link.includes("tnmr.org")||server.toLowerCase().includes("lulustream");return{server:server,link:link,type:"m3u8",headers:isLulu?{Referer:"https://luluvdo.com/",Origin:"https://luluvdo.com","User-Agent":"Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Mobile Safari/537.36",Accept:"*/*"}:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=void 0;const getStream=async function({link:link,providerContext:providerContext}){const{axios:axios,cheerio:cheerio,commonHeaders:commonHeaders}=providerContext;try{const res=await axios.get(link,{headers:commonHeaders}),iframeSrc=cheerio.load(res.data||"")("div.embed iframe").attr("src");if(!iframeSrc)return[];const iframeUrl=iframeSrc.startsWith("http")?iframeSrc:new URL(iframeSrc,link).href,iframeRes=await axios.get(iframeUrl,{headers:{...commonHeaders,Referer:link,"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"},maxRedirects:5}),$$=cheerio.load(iframeRes.data||""),tasks=[];$$("video source").each((_,el)=>{const src=$$(el).attr("src");src&&(src.includes(".m3u8")?tasks.push(Promise.resolve(buildM3U8Stream("Default",src))):tasks.push(Promise.resolve({server:"Default",link:src,type:"mp4"})))}),$$("li[onclick]").each((_,el)=>{var _a;const base64=null===(_a=($$(el).attr("onclick")||"").split("showVideo('")[1])||void 0===_a?void 0:_a.split("',")[0];if(!base64)return;const decodedUrl=decodeBase64(base64);if(!decodedUrl)return;const serverName=$$(el).text().trim()||"Server",task=axios.get(decodedUrl,{headers:{...commonHeaders,Referer:iframeUrl,"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"},timeout:1e4}).then(r=>{const body="string"==typeof r.data?r.data:JSON.stringify(r.data),m3u8=extractM3U8(body);if(m3u8)return buildM3U8Stream(serverName,m3u8);const mp4=extractMP4(body);return mp4?{server:serverName,link:mp4,type:"mp4"}:null}).catch(()=>null);serverName.toLowerCase().includes("lulustream")||serverName.toLowerCase().includes("vidmoly")?tasks.unshift(task):tasks.push(task)});try{const match=iframeRes.data.match(/sources\s*:\s*(\[[^\]]+\])/);if(match){JSON.parse(match[1].replace(/'/g,'"')).forEach(s=>{var _a;(null===(_a=s.src)||void 0===_a?void 0:_a.includes(".m3u8"))&&tasks.push(Promise.resolve(buildM3U8Stream(s.label||"VidStack",s.src)))})}for(const m of iframeRes.data.matchAll(/https?:\/\/[^\s"'<>]+\.m3u8[^\s"'<>]*/g))tasks.push(Promise.resolve(buildM3U8Stream("VidStack",m[0])))}catch(_a){}const results=(await Promise.all(tasks)).filter(Boolean),seen=new Set,unique=results.filter(s=>!seen.has(s.link)&&(seen.add(s.link),!0));return unique.sort((a,b)=>{const A=a.server.toLowerCase(),B=b.server.toLowerCase();return A.includes("lulustream")?-1:B.includes("lulustream")?1:A.includes("vidmoly")?-1:B.includes("vidmoly")?1:A.includes("vidstack")?-1:B.includes("vidstack")?1:0}),unique}catch(e){return[]}};exports.getStream=getStream;