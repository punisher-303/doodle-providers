"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=void 0,exports.getWebstreamerStream=getWebstreamerStream,exports.getRiveStream=getRiveStream;const getStream=function({link:id,type:type,providerContext:providerContext}){var _a,_b,_c,_d,_e,_f,_g,_h;const streams=[];let payload;try{payload=JSON.parse(id)}catch(e){payload={tmdbId:id}}const tmdbId=String(null!==(_c=null!==(_b=null!==(_a=payload.tmdbId)&&void 0!==_a?_a:payload.id)&&void 0!==_b?_b:payload.tmdId)&&void 0!==_c?_c:""),imdbId=String(null!==(_d=payload.imdbId)&&void 0!==_d?_d:""),season=String(null!==(_e=payload.season)&&void 0!==_e?_e:""),episode=String(null!==(_f=payload.episode)&&void 0!==_f?_f:""),effectiveType=null!==(_h=null!==(_g=payload.type)&&void 0!==_g?_g:type)&&void 0!==_h?_h:"movie",mediaData={tmdbId:tmdbId,imdbId:imdbId,season:season,episode:episode,type:effectiveType},sourcePromises=[getWebstreamerStream(imdbId,episode,season,effectiveType,streams,providerContext),getRiveStream(tmdbId,episode,season,effectiveType,streams,providerContext),getVidSrcCC(mediaData,streams,providerContext),getSmashyStream(mediaData,streams,providerContext),getTwoEmbed(mediaData,streams,providerContext),getGoku(mediaData,streams,providerContext),getMinochinos(mediaData,streams,providerContext),getSuperStream(mediaData,streams,providerContext)].map(function(p){return p.catch(function(e){return null})});return Promise.all(sourcePromises).then(function(){return streams.filter(function(v,i,a){return a.findIndex(function(t){return t.link===v.link})===i})})};function getWebstreamerStream(imdbId,episode,season,type,Streams,providerContext){if(!imdbId||"undefined"===imdbId)return Promise.resolve();const url="https://webstreamr.hayd.uk/"+JSON.stringify({multi:"on",al:"on",de:"on",es:"on",fr:"on",hi:"on",it:"on",mx:"on",mediaFlowProxyUrl:"",mediaFlowProxyPassword:""})+"/stream/"+type+"/"+imdbId+("series"===type?":"+season+":"+episode:"")+".json";return providerContext.axios.get(encodeURI(url),{timeout:15e3,headers:providerContext.commonHeaders}).then(function(res){res.data&&res.data.streams&&res.data.streams.forEach(function(source){const url=null==source?void 0:source.url,name=(null==source?void 0:source.name)||"WebStreamer",qualityMatch=null==name?void 0:name.match(/(\d{3,4})p/),quality=qualityMatch?qualityMatch[1]:void 0;Streams.push({server:name,link:url,type:"movie"===type?"movie":"series",quality:quality})})})}function getRiveStream(tmdId,episode,season,type,Streams,providerContext){if(!tmdId||"undefined"===tmdId)return Promise.resolve();const secret=generateSecretKey(tmdId),servers=["flowcast","asiacloud","humpy","primevids","shadow","hindicast","animez","aqua","yggdrasil","putafilme","ophim"];return new Promise(function(resolve){try{resolve(providerContext.getBaseUrl("rive"))}catch(e){resolve("https://rive-stream-api.vercel.app")}}).then(function(baseUrl){baseUrl||(baseUrl="https://rive-stream-api.vercel.app");const cors=process.env.CORS_PRXY?process.env.CORS_PRXY+"?url=":"",route="series"===type?"/api/backendfetch?requestID=tvVideoProvider&id="+tmdId+"&season="+season+"&episode="+episode+"&secretKey="+secret+"&service=":"/api/backendfetch?requestID=movieVideoProvider&id="+tmdId+"&secretKey="+secret+"&service=",url=cors?cors+encodeURIComponent(baseUrl+route):baseUrl+route,promises=servers.map(function(server){return providerContext.axios.get(url+server,{timeout:8e3}).then(function(res){res.data&&res.data.data&&res.data.data.sources&&res.data.data.sources.forEach(function(source){Streams.push({server:"Rive-"+(null==source?void 0:source.source)+"-"+(null==source?void 0:source.quality),link:null==source?void 0:source.url,type:"hls"===(null==source?void 0:source.format)?"m3u8":"mp4",quality:null==source?void 0:source.quality,headers:{referer:baseUrl}})})}).catch(function(){})});return Promise.all(promises)})}function getVidSrcCC(data,streams,ctx){const BASE_URL="https://vidsrc.cc",tmdbId=data.tmdbId,imdbId=data.imdbId,season=data.season,episode=data.episode;let url="";return url="movie"===data.type?BASE_URL+"/v2/embed/movie/"+(imdbId||tmdbId):BASE_URL+"/v2/embed/tv/"+(imdbId||tmdbId)+"/"+season+"/"+episode,ctx.axios.get(url,{timeout:1e4}).then(function(res){const html=res.data,match=html.match(/file:\s*['"](https?:\/\/[^'"]+\.m3u8)['"]/);match&&match[1]&&streams.push({server:"VidSrc.cc (Direct)",link:match[1],type:"m3u8",headers:{Referer:BASE_URL,"User-Agent":"Mozilla/5.0"}});const sourceMatch=html.match(/sources:\s*(\[\{.*?\}\])/s);if(sourceMatch&&sourceMatch[1])try{const fileMatches=sourceMatch[1].matchAll(/file:\s*["']([^"']+)["']/g);for(const m of fileMatches)m[1].includes(".m3u8")&&streams.push({server:"VidSrc.cc (Proxy)",link:m[1],type:"m3u8"})}catch(e){}})}function getSmashyStream(data,streams,ctx){const BASE_URL="https://embed.smashystream.com",url=BASE_URL+"/playere.php?tmdb="+data.tmdbId+"&season="+(data.season||"")+"&episode="+(data.episode||"");return ctx.axios.get(url,{headers:{Referer:BASE_URL}}).then(function(res){const $=ctx.cheerio.load(res.data),extractPromises=[];return $(".dropdown-menu .dropdown-item").each(function(_,el){const link=$(el).attr("data-url"),name=$(el).text().trim();link&&"#"!==link&&extractPromises.push(extractUniversal(link,"Smashy-"+name,ctx,streams))}),Promise.all(extractPromises.map(function(p){return p.catch(function(){})}))}).then(function(){})}function getTwoEmbed(data,streams,ctx){const tmdbId=data.tmdbId,imdbId=data.imdbId,season=data.season,episode=data.episode;let url="";return url="movie"===data.type?"https://www.2embed.cc/embed/"+(imdbId||tmdbId):"https://www.2embed.cc/embed/"+(imdbId||tmdbId)+"/"+season+"/"+episode,ctx.axios.get(url).then(function(res){const $=ctx.cheerio.load(res.data),promises=[];$(".server-btn, .btn-server").each(function(_,el){const embedUrl=$(el).attr("data-src")||$(el).attr("data-link"),name=$(el).text().trim()||"2Embed";embedUrl&&promises.push(extractUniversal(embedUrl,name,ctx,streams))});const defaultIframe=$("iframe").attr("src");return defaultIframe&&promises.push(extractUniversal(defaultIframe,"2Embed-Default",ctx,streams)),Promise.all(promises.map(function(p){return p.catch(function(){})}))}).then(function(){})}function getGoku(data,streams,ctx){return Promise.resolve()}function getMinochinos(data,streams,ctx){return Promise.resolve()}function getSuperStream(data,streams,ctx){return Promise.resolve()}function extractUniversal(url,serverName,ctx,streams){return url?(url.startsWith("//")&&(url="https:"+url),url.match(/\.m3u8($|\?)/)?(streams.push({server:serverName,link:url,type:"m3u8"}),Promise.resolve()):url.match(/\.mp4($|\?)/)?(streams.push({server:serverName,link:url,type:"mp4"}),Promise.resolve()):url.includes("streamwish")||url.includes("embedwish")||url.includes("filelions")?extractWishLions(url,serverName,ctx,streams):url.includes("voe.sx")?extractVoe(url,serverName,ctx,streams):url.includes("rabbitstream")||url.includes("dokicloud")?Promise.resolve():ctx.axios.get(url,{headers:{Referer:url}}).then(function(res){const src=ctx.cheerio.load(res.data)("iframe").attr("src");if(src&&!src.includes(url))return extractUniversal(src,serverName+" (Embed)",ctx,streams)}).catch(function(){})):Promise.resolve()}function extractWishLions(url,name,ctx,streams){return ctx.axios.get(url).then(function(res){const match=res.data.match(/file\s*:\s*["']([^"']+\.m3u8)["']/);match&&match[1]&&streams.push({server:name,link:match[1],type:"m3u8",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",Referer:url}})}).catch(function(){})}function extractVoe(url,name,ctx,streams){return ctx.axios.get(url).then(function(res){const hlsMatch=res.data.match(/'hls':\s*'([^']+)'/);if(hlsMatch&&hlsMatch[1])return void streams.push({server:name,link:hlsMatch[1],type:"m3u8",headers:{Referer:url}});const mp4Match=res.data.match(/'mp4':\s*'([^']+)'/);mp4Match&&mp4Match[1]&&streams.push({server:name,link:mp4Match[1],type:"mp4",headers:{Referer:url}})}).catch(function(){})}function generateSecretKey(id){const c=["4Z7lUo","gwIVSMD","PLmz2elE2v","Z4OFV0","SZ6RZq6Zc","zhJEFYxrz8","FOm7b0","axHS3q4KDq","o9zuXQ","4Aebt","wgjjWwKKx","rY4VIxqSN","kfjbnSo","2DyrFA1M","YUixDM9B","JQvgEj0","mcuFx6JIek","eoTKe26gL","qaI9EVO1rB","0xl33btZL","1fszuAU","a7jnHzst6P","wQuJkX","cBNhTJlEOf","KNcFWhDvgT","XipDGjST","PCZJlbHoyt","2AYnMZkqd","HIpJh","KH0C3iztrG","W81hjts92","rJhAT","NON7LKoMQ","NMdY3nsKzI","t4En5v","Qq5cOQ9H","Y9nwrp","VX5FYVfsf","cE5SJG","x1vj1","HegbLe","zJ3nmt4OA","gt7rxW57dq","clIE9b","jyJ9g","B5jXjMCSx","cOzZBZTV","FTXGy","Dfh1q1","ny9jqZ2POI","X2NnMn","MBtoyD","qz4Ilys7wB","68lbOMye","3YUJnmxp","1fv5Imona","PlfvvXD7mA","ZarKfHCaPR","owORnX","dQP1YU","dVdkx","qgiK0E","cx9wQ","5F9bGa","7UjkKrp","Yvhrj","wYXez5Dg3","pG4GMU","MwMAu","rFRD5wlM"];if(void 0===id)return"rive";try{let t,n;const r=String(id);if(isNaN(Number(id))){const sum=r.split("").reduce(function(e,ch){return e+ch.charCodeAt(0)},0);t=c[sum%c.length]||btoa(r),n=Math.floor(sum%r.length/2)}else{const num=Number(id);t=c[num%c.length]||btoa(r),n=Math.floor(num%r.length/2)}const i=r.slice(0,n)+t+r.slice(n),innerHash=function(e){e=String(e);let t=0;for(let n=0;n<e.length;n++){const r=e.charCodeAt(n),i=((t=r+(t<<6)+(t<<16)-t>>>0)<<n%5|t>>>32-n%5)>>>0;t=(t^i^(r<<n%7|r>>>8-n%7)>>>0)>>>0,t=t+(t>>>11^t<<3)>>>0}return t^=t>>>15,t=49842*(65535&t)+((49842*(t>>>16)&65535)<<16)>>>0,t^=t>>>13,t=40503*(65535&t)+((40503*(t>>>16)&65535)<<16)>>>0,t^=t>>>16,t.toString(16).padStart(8,"0")},outerHash=function(e){const t=String(e);let n=(3735928559^t.length)>>>0;for(let idx=0;idx<t.length;idx++){let r=t.charCodeAt(idx);r^=255&(131*idx+89^r<<idx%5),n=(n<<7|n>>>25)>>>0^r;n=(60205*(65535&n)>>>0)+(60205*(n>>>16)<<16>>>0)>>>0,n^=n>>>11}return n^=n>>>15,n=49842*(65535&n)+(49842*(n>>>16)<<16)>>>0>>>0,n^=n>>>13,n=40503*(65535&n)+(40503*(n>>>16)<<16)>>>0>>>0,n^=n>>>16,n=10196*(65535&n)+(10196*(n>>>16)<<16)>>>0>>>0,n^=n>>>15,n.toString(16).padStart(8,"0")},o=outerHash(innerHash(i));return btoa(o)}catch(e){return"topSecret"}}exports.getStream=getStream;