"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getEpisodes=void 0;const headers={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Referer:"https://fibtoon.top/"},getEpisodes=function({url:url,providerContext:providerContext}){const{getBaseUrl:getBaseUrl,axios:axios,cheerio:cheerio}=providerContext;return getBaseUrl("fibtoon").then(baseUrl=>{if(url.startsWith("season:")){const parts=url.split(":"),seasonNum=parseInt(parts[1]),parentVideoId=parts[3];return axios.get(`${baseUrl}/ajax/episodes.php?video_id=${parentVideoId}`,{headers:headers}).then(epRes=>{if(!epRes.data||!Array.isArray(epRes.data.episodes))return[];const episodePromises=epRes.data.episodes.filter(ep=>{const sMatch=ep.title.match(/s(\d{1,2})/i);return sMatch&&parseInt(sMatch[1])===seasonNum}).map(ep=>{const epPageUrl=ep.url.trim().startsWith("http")?ep.url.trim():`${baseUrl}${ep.url.trim().startsWith("/")?"":"/"}${ep.url.trim()}`;return axios.get(epPageUrl,{headers:headers}).then(pageRes=>{var _a;const $=cheerio.load(pageRes.data),innerVideoId=null===(_a=$("input#video-id").val())||void 0===_a?void 0:_a.toString();let finalLink="",switcherPromise=Promise.resolve();return innerVideoId&&(switcherPromise=axios.get(`${baseUrl}/ajax/resolution_switcher.php?video_id=${innerVideoId}`,{headers:headers}).then(switcher=>{const validSource=[...switcher.data.current||[],...switcher.data.popup||[]].find(s=>s.url);validSource&&(finalLink=validSource.url)}).catch(()=>{})),switcherPromise.then(()=>{if(!finalLink){const dlClick=$("a.hidden-button.buttonDownloadnew").attr("onclick"),match=null==dlClick?void 0:dlClick.match(/url=(.*?)',/);(null==match?void 0:match[1])&&(finalLink=match[1].trim())}return finalLink?(finalLink=finalLink.startsWith("http")?finalLink:`${baseUrl}${finalLink.startsWith("/")?"":"/"}${finalLink}`,{title:ep.title||"Episode",link:finalLink}):null})}).catch(error=>null)});return Promise.all(episodePromises).then(results=>results.filter(e=>null!==e))})}return Promise.resolve([{title:"Play Movie",link:url}])})};exports.getEpisodes=getEpisodes;